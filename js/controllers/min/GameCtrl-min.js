app.controller("GameCtrl",["$scope","$interval","$localStorage",function(e,o,r){e.rules={interval:500,costIncrease:1.12};var t={populationTotal:0,populationAvaischoolle:0,currency:100,supplies:100,landTotal:5,landAvaischoolle:5,culture:0,knowledge:1,land:[{type:!1,collect:0},{type:!1,collect:0},{type:!1,collect:0},{type:!1,collect:0},{type:!1,collect:0}],square:{buyCostCurrency:80,buyCostSupplies:0,buildTime:5,population:0},buildings:{house:{buildCostCurrency:20,buildCostSupplies:0,buildTime:5,population:5,gains:"currency",gainsAmount:5,autoCollect:!1,duration:5,amountBuilt:0},factory:{buildCostCurrency:30,buildCostSupplies:0,buildTime:10,population:-2,gains:"supplies",gainsAmount:5,autoCollect:!1,duration:10,amountBuilt:0},tavern:{buildCostCurrency:20,buildCostSupplies:20,buildTime:10,population:-3,culture:5,amountBuilt:0},school:{buildCostCurrency:60,buildCostSupplies:50,buildTime:20,population:-4,gains:"knowledge",gainsAmount:1,autoCollect:!1,duration:60,amountBuilt:0}},research:{wireTransfer:{description:"Your people can send their taxes by wire, no need to go door-to-door anymore.",cost:2,researched:!1},shipping:{description:"Supplies are delivered to your warehouse overnight, so you don't have to collect them yourself.",cost:4,researched:!1},cloudStorage:{description:"Your schools upload new knowledge directly to the city's wiki.",cost:8,researched:!1}},totalStats:{currency:0,supplies:0,knowledge:0}},s=function(){e.$storage=r.$default(t)};s(),e.resetGame=function(){console.log(e.$storage.$reset(t))},e.addLogEntry=function(e,o){var r;switch(o){case"info":r=" ";break;case"success":r="√";break;case"warning":r="!";break;case"debug":r="E"}console.log(r+" "+e)},e.addLogEntry("Welcome to idleopolis! Like to look under the hood? Here's the source: https://github.com/tobiv/idleopolis","info"),e.build=function(o){var r=e.$storage.buildings[o];if(!(e.$storage.currency>=r.buildCostCurrency&&e.$storage.supplies>=r.buildCostSupplies))return e.addLogEntry("Not enough funds!","warning"),!1;if(r.population<0&&e.$storage.populationAvaischoolle<-1*r.population)return e.addLogEntry("Not enough population","warning"),!1;var t=e.$storage.land.map(function(e){return e.type}).indexOf(!1);return t>-1?(e.$storage.currency-=r.buildCostCurrency,e.$storage.supplies-=r.buildCostSupplies,e.$storage.land[t].type=o,e.$storage.land[t].progress=0,e.$storage.land[t].collect=0,r.amountBuilt+=1,r.population>0&&(e.$storage.populationTotal+=r.population),e.$storage.populationAvaischoolle+=r.population,e.$storage.landAvaischoolle-=1,r.buildCostCurrency=Math.ceil(r.buildCostCurrency*e.rules.costIncrease),0===r.buildCostSupplies&&(r.buildCostSupplies=5),r.buildCostSupplies=Math.ceil(r.buildCostSupplies*e.rules.costIncrease),void 0):(e.addLogEntry("Not enough land","warning"),!1)},e.buyLand=function(){if(!(e.$storage.currency>=e.$storage.square.buyCostCurrency&&e.$storage.supplies>=e.$storage.square.buyCostSupplies))return e.addLogEntry("Not enough funds!","warning"),!1;e.$storage.currency-=e.$storage.square.buyCostCurrency,e.$storage.supplies-=e.$storage.square.buyCostSupplies;var o={type:!1,collect:0};e.$storage.land.push(o);var r=document.getElementById("io-the-land");r.scrollTop=r.scrollHeight,e.addLogEntry("Bought one square of land for c"+e.$storage.square.buyCostCurrency+" s"+e.$storage.square.buyCostSupplies,"success"),e.$storage.landTotal+=1,e.$storage.landAvaischoolle+=1,e.$storage.square.buyCostCurrency=Math.ceil(e.$storage.square.buyCostCurrency*e.rules.costIncrease),0===e.$storage.square.buyCostSupplies&&(e.$storage.square.buyCostSupplies=10),e.$storage.square.buyCostSupplies=Math.ceil(e.$storage.square.buyCostSupplies*e.rules.costIncrease)},e.collectSquare=function(o){if(e.$storage.land[o].collect>0){var r=e.$storage.land[o].type,t=e.$storage.buildings[r],s=t.gains;e.$storage[s]+=e.$storage.land[o].collect,e.$storage.totalStats[s]+=e.$storage.land[o].collect,e.$storage.land[o].collect=0,e.$storage.land[o].progress=0}},e.research=function(o){switch(o){case"wireTransfer":if(e.$storage.research.wireTransfer.researched===!0)return e.addLogEntry("Already researched!","warning"),!1;if(!(e.$storage.knowledge>=e.$storage.research.wireTransfer.cost))return e.addLogEntry("Not enough knowledge!","warning"),!1;e.$storage.knowledge-=e.$storage.research.wireTransfer.cost,e.$storage.research.wireTransfer.researched=!0,e.$storage.buildings.house.autoCollect=!0,e.addLogEntry("Researched Wire Transfer – taxes are collected automatically now","success");break;case"shipping":if(e.$storage.research.shipping.researched===!0)return e.addLogEntry("Already researched!","warning"),!1;if(!(e.$storage.knowledge>=e.$storage.research.shipping.cost))return e.addLogEntry("Not enough knowledge!","warning"),!1;e.$storage.knowledge-=e.$storage.research.shipping.cost,e.$storage.research.shipping.researched=!0,e.$storage.buildings.factory.autoCollect=!0,e.addLogEntry("Researched Shipping – supplies are collected automatically now","success");break;case"cloudStorage":if(e.$storage.research.cloudStorage.researched===!0)return e.addLogEntry("Already researched!","warning"),!1;if(!(e.$storage.knowledge>=e.$storage.research.cloudStorage.cost))return e.addLogEntry("Not enough knowledge!","warning"),!1;e.$storage.knowledge-=e.$storage.research.cloudStorage.cost,e.$storage.research.cloudStorage.researched=!0,e.$storage.buildings.school.autoCollect=!0,e.addLogEntry("Researched Cloud Storage – knowledge is collected automatically now","success")}},e.cheat=function(){e.$storage.currency+=1e5,e.$storage.supplies+=1e5,e.$storage.knowledge+=100},e.$on("$destroy",function(){angular.isDefined(a)&&(o.cancel(a),a=void 0)});var a=o(function(){for(var o=e.$storage.land.length,r,t,s,a=0;o>a;a++)s=e.$storage.land[a],s.type!==!1&&s.construction!==!0&&0===s.collect&&(r=s.type,t=e.$storage.buildings[r],s.progress+=100/(1e3*t.duration/e.rules.interval),s.progress>99&&(s.collect=t.gainsAmount,t.autoCollect===!0&&e.collectSquare(a))),s.construction===!0},e.rules.interval,0)}]);